#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะบะพะฟะธัะพะฒะฐะฝะธั ะฟัะพะตะบัะฐ ะฒ WSL native FS

set -e

# ะฆะตะปะตะฒะฐั ะดะธัะตะบัะพัะธั
TARGET_DIR=~/projects/vllm-setup

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}๐ ะะพะฟะธัะพะฒะฐะฝะธะต ะฟัะพะตะบัะฐ ะฒ WSL native FS${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ะขะตะบััะฐั ะดะธัะตะบัะพัะธั
CURRENT_DIR=$(pwd)
echo -e "${YELLOW}ะััะพัะฝะธะบ:${NC} $CURRENT_DIR"
echo -e "${YELLOW}ะฆะตะปั:${NC}     $TARGET_DIR"
echo ""

# ะัะพะฒะตัะบะฐ ััะพ ะฝะต ะบะพะฟะธััะตะผ ัะฐะผะธ ะฒ ัะตะฑั
if [ "$CURRENT_DIR" = "$TARGET_DIR" ]; then
    echo -e "${RED}โ ะัะธะฑะบะฐ: ะััะพัะฝะธะบ ะธ ัะตะปั ัะพะฒะฟะฐะดะฐัั!${NC}"
    exit 1
fi

# ะัะพะฒะตัะบะฐ ััะพ ัะตะปะตะฒะฐั ะดะธัะตะบัะพัะธั ัััะตััะฒัะตั
if [ -d "$TARGET_DIR" ]; then
    echo -e "${YELLOW}โ๏ธ  ะฆะตะปะตะฒะฐั ะดะธัะตะบัะพัะธั ัะถะต ัััะตััะฒัะตั${NC}"
    
    # ะะพะบะฐะทะฐัั ัะพะดะตัะถะธะผะพะต
    echo ""
    echo "ะกะพะดะตัะถะธะผะพะต $TARGET_DIR:"
    ls -lah "$TARGET_DIR" | head -10
    echo ""
    
    read -p "ะฃะดะฐะปะธัั ัััะตััะฒััััั ะดะธัะตะบัะพัะธั ะธ ะฟัะพะดะพะปะถะธัั? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}โ ะัะผะตะฝะตะฝะพ${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}๐๏ธ  ะฃะดะฐะปะตะฝะธะต ััะฐัะพะน ะดะธัะตะบัะพัะธะธ...${NC}"
    rm -rf "$TARGET_DIR"
fi

# ะกะพะทะดะฐะฝะธะต ัะพะดะธัะตะปััะบะพะน ะดะธัะตะบัะพัะธะธ
echo -e "${GREEN}๐ ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ...${NC}"
mkdir -p "$(dirname "$TARGET_DIR")"

# ะะพะฟะธัะพะฒะฐะฝะธะต ั ะธัะบะปััะตะฝะธะตะผ .venv
echo -e "${GREEN}๐ฆ ะะพะฟะธัะพะฒะฐะฝะธะต ัะฐะนะปะพะฒ (ะธัะบะปััะฐั .venv)...${NC}"
echo ""

# ะัะฟะพะปัะทัะตะผ rsync ะดะปั ะบัะฐัะธะฒะพะณะพ ะฟัะพะณัะตััะฐ ะธ ะธัะบะปััะตะฝะธะน
if command -v rsync &> /dev/null; then
    rsync -av --progress \
        --exclude='.venv' \
        --exclude='.venv/' \
        --exclude='__pycache__' \
        --exclude='*.pyc' \
        --exclude='.git/objects' \
        "$CURRENT_DIR/" "$TARGET_DIR/"
else
    # Fallback: ะธัะฟะพะปัะทัะตะผ cp ั find
    echo -e "${YELLOW}โน๏ธ  rsync ะฝะต ะฝะฐะนะดะตะฝ, ะธัะฟะพะปัะทัะตะผ cp...${NC}"
    
    # ะกะพะทะดะฐะตะผ ัะตะปะตะฒัั ะดะธัะตะบัะพัะธั
    mkdir -p "$TARGET_DIR"
    
    # ะะพะฟะธััะตะผ ะฒัะต ัะฐะนะปั ะบัะพะผะต .venv
    find "$CURRENT_DIR" -mindepth 1 -maxdepth 1 ! -name '.venv' -exec cp -r {} "$TARGET_DIR/" \;
fi

echo ""
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โ ะะพะฟะธัะพะฒะฐะฝะธะต ะทะฐะฒะตััะตะฝะพ!${NC}"
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ะกัะฐัะธััะธะบะฐ
echo "๐ ะกัะฐัะธััะธะบะฐ:"
echo -e "   ะััะพะดะฝะฐั ะดะธัะตะบัะพัะธั: ${BLUE}$(du -sh "$CURRENT_DIR" | cut -f1)${NC}"
echo -e "   ะะพะฒะฐั ะดะธัะตะบัะพัะธั:    ${BLUE}$(du -sh "$TARGET_DIR" | cut -f1)${NC}"
echo ""

# ะกะฟะธัะพะบ ัะบะพะฟะธัะพะฒะฐะฝะฝัั ัะฐะนะปะพะฒ
echo "๐ ะกะบะพะฟะธัะพะฒะฐะฝะฝัะต ัะฐะนะปั ะธ ะดะธัะตะบัะพัะธะธ:"
ls -lah "$TARGET_DIR" | tail -n +4 | head -15
FILE_COUNT=$(find "$TARGET_DIR" -type f | wc -l)
DIR_COUNT=$(find "$TARGET_DIR" -type d | wc -l)
echo ""
echo -e "   ะัะตะณะพ ัะฐะนะปะพะฒ: ${GREEN}$FILE_COUNT${NC}"
echo -e "   ะัะตะณะพ ะดะธัะตะบัะพัะธะน: ${GREEN}$DIR_COUNT${NC}"
echo ""

# ะัะพะฒะตัะบะฐ ัะฐะนะปะพะฒะพะน ัะธััะตะผั
echo "๐ ะัะพะฒะตัะบะฐ ัะฐะนะปะพะฒะพะน ัะธััะตะผั:"
OLD_FS=$(df -T "$CURRENT_DIR" | tail -1 | awk '{print $2}')
NEW_FS=$(df -T "$TARGET_DIR" | tail -1 | awk '{print $2}')
echo -e "   ะกัะฐัะฐั FS: ${YELLOW}$OLD_FS${NC}"
echo -e "   ะะพะฒะฐั FS:  ${GREEN}$NEW_FS${NC}"

if [[ "$OLD_FS" == "9p" ]] || [[ "$OLD_FS" == "drvfs" ]]; then
    echo -e "   ${GREEN}โ ะะตัะตะผะตัะตะฝะพ ั Windows FS ะฝะฐ Linux FS!${NC}"
fi

echo ""
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}๐ ะกะปะตะดัััะธะต ัะฐะณะธ:${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""
echo "1. ะะตัะตะนะดะธัะต ะฒ ะฝะพะฒัั ะดะธัะตะบัะพัะธั:"
echo -e "   ${GREEN}cd $TARGET_DIR${NC}"
echo ""
echo "2. ะกะพะทะดะฐะนัะต ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต:"
echo -e "   ${GREEN}uv venv${NC}"
echo ""
echo "3. ะะบัะธะฒะธััะนัะต ะพะบััะถะตะฝะธะต:"
echo -e "   ${GREEN}source .venv/bin/activate${NC}"
echo ""
echo "4. ะฃััะฐะฝะพะฒะธัะต ะทะฐะฒะธัะธะผะพััะธ:"
echo -e "   ${GREEN}uv sync${NC}"
echo ""
echo "5. ะะฐะฟัััะธัะต ัะตัะฒะตั:"
echo -e "   ${GREEN}./start_server.sh${NC}"
echo ""
echo -e "${YELLOW}๐ก ะกะพะฒะตั: ะะพัะปะต ะฟัะพะฒะตัะบะธ ััะพ ะฒัั ัะฐะฑะพัะฐะตั, ะผะพะถะตัะต ัะดะฐะปะธัั ััะฐััั ะดะธัะตะบัะพัะธั:${NC}"
echo -e "   ${YELLOW}rm -rf $CURRENT_DIR${NC}"
echo ""
