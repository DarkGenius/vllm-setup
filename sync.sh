#!/bin/bash

# ะกะบัะธะฟั ะดะปั ัะธะฝััะพะฝะธะทะฐัะธะธ ะฟัะพะตะบัะฐ ะฒ WSL native FS

set -e

# ะฆะตะปะตะฒะฐั ะดะธัะตะบัะพัะธั
TARGET_DIR=~/projects/vllm-setup

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}๐ ะกะธะฝััะพะฝะธะทะฐัะธั ะฟัะพะตะบัะฐ ะฒ WSL native FS${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ะขะตะบััะฐั ะดะธัะตะบัะพัะธั
CURRENT_DIR=$(pwd)
echo -e "${YELLOW}ะััะพัะฝะธะบ:${NC} $CURRENT_DIR"
echo -e "${YELLOW}ะฆะตะปั:${NC}     $TARGET_DIR"
echo ""

# ะัะพะฒะตัะบะฐ ััะพ ะฝะต ัะธะฝััะพะฝะธะทะธััะตะผ ัะฐะผะธ ะฒ ัะตะฑั
if [ "$CURRENT_DIR" = "$TARGET_DIR" ]; then
    echo -e "${RED}โ ะัะธะฑะบะฐ: ะััะพัะฝะธะบ ะธ ัะตะปั ัะพะฒะฟะฐะดะฐัั!${NC}"
    exit 1
fi

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั rsync
if ! command -v rsync &> /dev/null; then
    echo -e "${RED}โ ะัะธะฑะบะฐ: rsync ะฝะต ะฝะฐะนะดะตะฝ. ะฃััะฐะฝะพะฒะธัะต rsync ะดะปั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ััะพะณะพ ัะบัะธะฟัะฐ.${NC}"
    exit 1
fi

# ะกะพะทะดะฐะฝะธะต ัะพะดะธัะตะปััะบะพะน ะดะธัะตะบัะพัะธะธ
if [ ! -d "$TARGET_DIR" ]; then
    echo -e "${GREEN}๐ ะกะพะทะดะฐะฝะธะต ัะตะปะตะฒะพะน ะดะธัะตะบัะพัะธะธ...${NC}"
    mkdir -p "$(dirname "$TARGET_DIR")"
else
    echo -e "${GREEN}๐ ะฆะตะปะตะฒะฐั ะดะธัะตะบัะพัะธั ัะถะต ัััะตััะฒัะตั${NC}"
    echo -e "${YELLOW}โน๏ธ  ะคะฐะนะปั, ะบะพัะพััะต ะตััั ัะพะปัะบะพ ะฒ ัะตะปะตะฒะพะผ ะบะฐัะฐะปะพะณะต, ะฑัะดัั ัะพััะฐะฝะตะฝั${NC}"
fi

# ะกะธะฝััะพะฝะธะทะฐัะธั ั ะธัะบะปััะตะฝะธะตะผ .venv
echo ""
echo -e "${GREEN}๐ ะกะธะฝััะพะฝะธะทะฐัะธั ัะฐะนะปะพะฒ (ะธัะบะปััะฐั .venv)...${NC}"
echo ""

# ะัะฟะพะปัะทัะตะผ rsync ะะะ --delete, ััะพะฑั ะฝะต ัะดะฐะปััั ัะฐะนะปั ะฒ destination
rsync -av --progress \
    --exclude='.venv' \
    --exclude='.venv/' \
    --exclude='__pycache__' \
    --exclude='__pycache__/' \
    --exclude='*.pyc' \
    --exclude='.git/objects' \
    "$CURRENT_DIR/" "$TARGET_DIR/"

echo ""
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โ ะกะธะฝััะพะฝะธะทะฐัะธั ะทะฐะฒะตััะตะฝะฐ!${NC}"
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ะกัะฐัะธััะธะบะฐ
echo "๐ ะกัะฐัะธััะธะบะฐ:"
echo -e "   ะััะพะดะฝะฐั ะดะธัะตะบัะพัะธั: ${BLUE}$(du -sh "$CURRENT_DIR" | cut -f1)${NC}"
echo -e "   ะฆะตะปะตะฒะฐั ะดะธัะตะบัะพัะธั:  ${BLUE}$(du -sh "$TARGET_DIR" | cut -f1)${NC}"
echo ""

# ะกะฟะธัะพะบ ัะฐะนะปะพะฒ ะฒ ัะตะปะตะฒะพะน ะดะธัะตะบัะพัะธะธ
echo "๐ ะกะพะดะตัะถะธะผะพะต ัะตะปะตะฒะพะน ะดะธัะตะบัะพัะธะธ:"
ls -lah "$TARGET_DIR" | tail -n +4 | head -15
FILE_COUNT=$(find "$TARGET_DIR" -type f | wc -l)
DIR_COUNT=$(find "$TARGET_DIR" -type d | wc -l)
echo ""
echo -e "   ะัะตะณะพ ัะฐะนะปะพะฒ: ${GREEN}$FILE_COUNT${NC}"
echo -e "   ะัะตะณะพ ะดะธัะตะบัะพัะธะน: ${GREEN}$DIR_COUNT${NC}"
echo ""

# ะัะพะฒะตัะบะฐ ัะฐะนะปะพะฒะพะน ัะธััะตะผั
echo "๐ ะัะพะฒะตัะบะฐ ัะฐะนะปะพะฒะพะน ัะธััะตะผั:"
OLD_FS=$(df -T "$CURRENT_DIR" | tail -1 | awk '{print $2}')
NEW_FS=$(df -T "$TARGET_DIR" | tail -1 | awk '{print $2}')
echo -e "   ะััะพัะฝะธะบ FS: ${YELLOW}$OLD_FS${NC}"
echo -e "   ะฆะตะปั FS:     ${GREEN}$NEW_FS${NC}"

if [[ "$OLD_FS" == "9p" ]] || [[ "$OLD_FS" == "drvfs" ]]; then
    echo -e "   ${GREEN}โ ะกะธะฝััะพะฝะธะทะธัะพะฒะฐะฝะพ ั Windows FS ะฝะฐ Linux FS!${NC}"
fi

echo ""

